# Service Market Simulator

서비스 마켓의 동작을 시뮬레이션하여 멀티 테넌트 서비스를 테스트합니다.

## 개요

실제 서비스 마켓(`~/workspace/service_market`)이 AI 서비스에 보내는 웹훅을 시뮬레이션합니다.
개발 업체는 이 시뮬레이터를 사용하여 웹훅 처리 로직을 테스트할 수 있습니다.

## 주요 기능

1. **데모 신청 (30일)**: 30일 체험판 신청 생성 및 웹훅 전송
2. **서비스 신청 (커스텀 기간)**: 정식 서비스 신청 생성 및 웹훅 전송
3. **결과 저장**: 웹훅 응답을 SQLite에 저장
4. **통계 조회**: 성공률, 평균 응답 시간 등 통계 확인
5. **pytest 연동**: 테스트에서 fixture로 사용 가능

## 빠른 시작

### 1. 의존성 설치

```bash
cd ~/workspace/multi_tenant_paas/sandbox/simulator
pip install -r requirements.txt
```

### 2. 서버 실행

```bash
# 시뮬레이터 서버 시작 (포트 9000)
python -m sandbox.simulator.cli serve --port 9000

# API 문서 확인
# http://localhost:9000/docs
```

### 3. 웹훅 테스트

```bash
# 1. 샘플 서비스 실행 (별도 터미널)
cd ~/workspace/multi_tenant_paas/sandbox/sample_service
uvicorn server:app --port 8000

# 2. 데모 신청 생성 및 웹훅 전송
python -m sandbox.simulator.cli demo \
    --target http://localhost:8000/api/tenant/webhook/application-approved \
    --email test@seoul.ac.kr \
    --university "서울대학교"

# 3. 결과 확인
python -m sandbox.simulator.cli results
python -m sandbox.simulator.cli stats
```

## CLI 명령어

### serve - 서버 실행

```bash
python -m sandbox.simulator.cli serve [옵션]

옵션:
  --port PORT    서버 포트 (기본값: 9000)
  --host HOST    서버 호스트 (기본값: 0.0.0.0)
  --db PATH      데이터베이스 경로 (기본값: simulator.db)
```

### demo - 데모 신청

```bash
python -m sandbox.simulator.cli demo [옵션]

옵션:
  --target URL         웹훅 대상 URL (필수 아님, 지정하면 즉시 전송)
  --email EMAIL        신청자 이메일 (기본값: test@university.ac.kr)
  --name NAME          신청자 이름 (기본값: Test User)
  --university NAME    대학명 (기본값: Test University)
  --api-key KEY        API 키 (기본값: mt_dev_key_12345)
```

### service - 서비스 신청

```bash
python -m sandbox.simulator.cli service [옵션]

옵션:
  --target URL         웹훅 대상 URL
  --email EMAIL        신청자 이메일 (필수)
  --start-date DATE    시작일 YYYY-MM-DD (필수)
  --end-date DATE      종료일 YYYY-MM-DD (필수)
  --name NAME          신청자 이름
  --university NAME    대학명
```

### applications - 신청 목록

```bash
python -m sandbox.simulator.cli applications [옵션]

옵션:
  --kind KIND      필터: demo 또는 service
  --status STATUS  필터: pending, sent, completed, failed
  --limit N        결과 개수 제한
  --json           JSON 형식 출력
```

### results - 결과 조회

```bash
python -m sandbox.simulator.cli results [옵션]

옵션:
  --application-id ID  특정 신청의 결과만 조회
  --limit N            결과 개수 제한
  --json               JSON 형식 출력
```

### stats - 통계

```bash
python -m sandbox.simulator.cli stats [--json]
```

## API 엔드포인트

### 신청 관리

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/applications/demo` | 데모 신청 생성 |
| POST | `/applications/service` | 서비스 신청 생성 |
| GET | `/applications` | 신청 목록 조회 |
| GET | `/applications/{id}` | 신청 상세 조회 |
| POST | `/applications/{id}/send` | 웹훅 전송 |
| DELETE | `/applications/{id}` | 신청 삭제 |

### 결과 조회

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/results` | 결과 목록 조회 |
| GET | `/results/{id}` | 결과 상세 조회 |
| GET | `/results/application/{id}` | 특정 신청의 결과 |
| DELETE | `/results` | 모든 결과 삭제 |

### 통계 및 기타

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/stats` | 통계 조회 |
| GET | `/health` | 헬스 체크 |
| GET | `/docs` | API 문서 (Swagger) |

## 웹훅 스펙 (실제 service_market 스펙)

### 요청 (시뮬레이터 → AI 서비스)

```http
POST /api/tenant/webhook/application-approved
X-API-Key: mt_dev_key_12345
Content-Type: application/json

{
    "application": {
        "id": 17,
        "kind": "demo",
        "contact": "02-880-1234",
        "reason": "AI 튜터 서비스 데모 체험 신청합니다."
    },
    "applicant": {
        "id": 27,
        "name": "김서울",
        "email": "seoul@university.ac.kr",
        "university_name": "서울대학교"
    },
    "service": {
        "id": 18,
        "slug": "keli-tutor",
        "title": "KELI Tutor"
    }
}
```

### 응답 (AI 서비스 → 시뮬레이터)

```json
{
    "success": true,
    "tenant_id": "seoul_university_17",
    "message": "테넌트 '서울대학교' 생성 완료",
    "access_url": "http://your-service.com?tenant=seoul_university_17",
    "admin_credentials": {
        "email": "seoul@university.ac.kr",
        "note": "LMS 계정으로 로그인하세요."
    },
    "created_at": "2026-01-04T21:38:22"
}
```

### 응답 필드 설명

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `success` | boolean | O | 성공 여부 |
| `tenant_id` | string | O | 생성된 테넌트 ID |
| `message` | string | O | 결과 메시지 |
| `access_url` | string | O | 서비스 접속 URL |
| `admin_credentials` | object | X | 관리자 로그인 정보 |
| `created_at` | string | X | 생성 일시 |

## pytest 연동

### fixture 사용

```python
# tests/conftest.py
from sandbox.simulator.fixtures import *

# tests/test_my_service.py
def test_webhook_handling(webhook_test_context):
    ctx = webhook_test_context

    # 신청 생성
    app = ctx.applications.create_demo_application(
        applicant_email="test@univ.ac.kr",
        applicant_name="Test",
        university_name="Test University"
    )

    # 웹훅 페이로드 생성
    payload = app.to_webhook_payload()

    # 여기서 실제 웹훅 처리 로직 테스트
    # ...

    # 결과 저장 (mock, 실제 service_market 스펙)
    result = ctx.results.save_result(
        application_id=app.id,
        target_url="http://localhost:8000/api/tenant/webhook/application-approved",
        request_payload=payload,
        response_code=200,
        response_body={
            "success": True,
            "tenant_id": "t1",
            "access_url": "http://localhost:8000/?tenant=t1",
            "message": "테넌트 생성 완료"
        },
        response_time_ms=100.0
    )

    assert result.success
```

### 사용 가능한 fixture

| Fixture | 설명 |
|---------|------|
| `simulator_db` | 인메모리 SQLite DB |
| `application_manager` | 신청 관리자 |
| `result_store` | 결과 저장소 |
| `sample_demo_application` | 샘플 데모 신청 |
| `sample_service_application` | 샘플 서비스 신청 |
| `sample_webhook_result` | 샘플 성공 결과 |
| `webhook_test_context` | 통합 컨텍스트 |
| `multiple_applications` | 여러 신청 (5개) |

## 테스트 실행

```bash
cd ~/workspace/multi_tenant_paas

# 시뮬레이터 단위 테스트
pytest tests/test_simulator.py -v

# 연동 테스트
pytest tests/test_market_integration.py -v

# 전체 테스트
pytest tests/ -v
```

## 파일 구조

```
sandbox/simulator/
├── __init__.py              # 패키지 exports
├── models.py                # 데이터 모델 (Application, WebhookResult)
├── database.py              # SQLite 데이터베이스 매니저
├── application_manager.py   # 신청 CRUD
├── result_store.py          # 결과 저장/조회
├── webhook_simulator.py     # FastAPI 서버
├── fixtures.py              # pytest fixtures
├── cli.py                   # CLI 도구
├── requirements.txt         # 의존성
└── README.md                # 이 문서
```

## 업체용 개발 가이드

### 1. 웹훅 엔드포인트 구현 (실제 service_market 스펙)

AI 서비스에서 다음 엔드포인트를 구현해야 합니다:

```python
from fastapi import FastAPI, Header, HTTPException, Request
from datetime import datetime

app = FastAPI()

@app.post("/api/tenant/webhook/application-approved")
async def handle_webhook(
    request: Request,
    x_api_key: str = Header(..., alias="X-API-Key")
):
    # 1. API 키 검증
    if x_api_key != "your_api_key":
        raise HTTPException(status_code=401, detail="Invalid API Key")

    # 2. 페이로드 처리 (실제 service_market 스펙)
    body = await request.json()
    application = body.get("application", {})
    applicant = body.get("applicant", {})

    application_id = application.get("id")
    kind = application.get("kind")  # "demo" or "service"
    email = applicant.get("email")
    university = applicant.get("university_name")

    # 3. 테넌트 생성 (동일 이메일이면 기존 테넌트 재사용)
    tenant_id = create_or_get_tenant(email, university)

    # 4. 응답 반환 (실제 service_market 스펙)
    return {
        "success": True,
        "tenant_id": tenant_id,
        "message": f"테넌트 '{university}' 생성 완료",
        "access_url": f"http://your-service.com?tenant={tenant_id}",
        "admin_credentials": {
            "email": email,
            "note": "LMS 계정으로 로그인하세요."
        },
        "created_at": datetime.now().isoformat()
    }
```

### 2. 테스트 절차

1. 시뮬레이터 서버 시작
2. AI 서비스 시작
3. CLI로 데모 신청 테스트
4. 결과 확인 및 디버깅
5. pytest로 자동화 테스트 작성

### 3. 체크리스트

- [ ] API 키 검증 구현
- [ ] 데모 신청 처리 (30일)
- [ ] 서비스 신청 처리 (커스텀 기간)
- [ ] 동일 이메일 테넌트 재사용
- [ ] 적절한 응답 반환 (success, tenant_id, access_url, message)
- [ ] 에러 처리

## 문의

문제가 있으면 이슈를 등록해주세요.
